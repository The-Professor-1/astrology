{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    {% block title %}
    <title>home</title>{% endblock title %}
</head>
{% block body %}
<body class="">
    <!-- Full-width, full-height image with overlay -->
    <div class="relative w-full h-96 lg:h-screen pt-16"> <!-- Adjust pt-16 based on navbar height -->
      <img src="{% static 'images/home-big-image.png' %}" alt="Background Image" class="w-full h-full object-cover">
      <div class="absolute inset-0 bg-black opacity-50"></div>
      <div class="absolute inset-0 flex flex-col items-center justify-center text-white text-center px-4">
          <h1 class="lg:text-7xl text-4xl font-bold">ወፍካሬ-ከዋክብት</h1>
          <p class="text-lg lg:text-4xl mt-2">የጥንታዊ ኢትዮጵያውያን ሊቃውንቶችና ጠበብቶች የምርምር ውጤት</p>
      </div>
    </div>
    
    
    
    <!-- Four Rounded Squares -->
    <div class="flex flex-wrap justify-center gap-6 p-10">
        <div class="w-32 h-8 lg:w-48 lg:h-12 flex items-center justify-center rounded-lg hover:bg-red-700 bg-red-500 text-white p-4 border border-gray-400">Content 1</div>
        <div class="w-32 h-8 lg:w-48 lg:h-12 flex items-center justify-center rounded-lg hover:bg-blue-700 bg-blue-500 text-white p-4 border border-gray-400">Content 2</div>
        <div class="w-32 h-8 lg:w-48 lg:h-12 flex items-center justify-center rounded-lg hover:bg-green-700 bg-green-500 text-white p-4 border border-gray-400">Content 3</div>
        <div class="w-32 h-8 lg:w-48 lg:h-12 flex items-center justify-center rounded-lg hover:bg-yellow-700 bg-yellow-500 text-white p-4 border border-gray-400">Content 4</div>
        <div class="w-32 h-8 lg:w-48 lg:h-12 flex items-center justify-center rounded-lg hover:bg-pink-700 bg-pink-500 text-white p-4 border border-gray-400">Content 5</div>
      </div>
      <br>
      <!-- Post Form -->
  <!-- Post Form -->
  <form method="POST" enctype="multipart/form-data" class="bg-white shadow-md p-4 rounded-lg mb-4">
    {% csrf_token %}
    <textarea name="text" class="w-full p-2 border rounded-md" placeholder="Write something..."></textarea>
    
    <!-- Hidden file input -->
    <input type="file" name="images" accept="image/*" multiple class="hidden" id="file-input">
    
    <!-- Image icon to trigger file input -->
    <label for="file-input" class="cursor-pointer mt-2 inline-block">
      <img src="{% static 'images/upload-icon.png' %}" alt="Upload" class="w-6 h-6">
    </label>
    
    <button type="submit" name='action' value='post_button' class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Post</button>
  </form>

<br>
<!-- Posts Section -->
<div class="max-w-2xl mx-auto mt-6">
  {% for post in posts %}
  <div class="bg-white shadow-md p-4 rounded-lg mb-4">
      <p>{{ post.text }}</p>
      {% for image in post.images.all %}
          <img src="{{ image.image.url }}" class="mt-2 w-full h-64 object-cover">
      {% endfor %}
      <div class="mt-2 flex justify-between">
          <button class="text-blue-500 like-btn" data-post-id="{{ post.id }}">
              Like (<span id="like-count-{{ post.id }}">{{ post.likes.count }}</span>)
          </button>
          <button class="text-gray-500 comment-btn" data-post-id="{{ post.id }}">Comment</button>
      </div>

      <!-- Comments -->
      <div id="comments-section-{{ post.id }}">
        {% for comment in post.comments.all %}
            <div class="p-2 border rounded my-2">
                <strong>{{ comment.user.username }}</strong>: {{ comment.text }}
                <small class="text-gray-500">{{ comment.created_at }}</small>
    
                <!-- Reply Form -->
                <div class="ml-4 mt-2">
                    <form class="reply-form" data-comment-id="{{ comment.id }}">
                        {% csrf_token %}
                        <input type="text" name="text" placeholder="Reply..." class="border p-1 w-3/4">
                        <button type="submit" class="bg-blue-500 text-white px-2 py-1">Reply</button>
                    </form>
    
                    <div id="replies-{{ comment.id }}">
                        {% for reply in comment.replies.all %}
                            <div class="ml-4 p-1 border rounded">
                                <strong>{{ reply.user.username }}</strong>: {{ reply.text }}
                                <small class="text-gray-500">{{ reply.created_at }}</small>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

      <!-- Comment Form -->
<form class="comment-form" data-post-id="{{ post.id }}">
  {% csrf_token %}
  <input type="text" name="text" placeholder="Add a comment..." class="border p-1 w-3/4">
  <button type="submit" class="bg-green-500 text-white px-2 py-1">Comment</button>
</form>
  </div>
  {% endfor %}
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    // Function to submit a new comment via AJAX
    $(".comment-form").submit(function (e) {
        e.preventDefault();  // Prevent page reload

        let post_id = $(this).data("post-id");
        let text = $(this).find("input[name='text']").val();
        let csrf_token = $("input[name='csrfmiddlewaretoken']").val();

        $.ajax({
            type: "POST",
            url: `/comment/${post_id}/`,
            data: {
                text: text,
                csrfmiddlewaretoken: csrf_token
            },
            success: function (response) {
                let commentHtml = `
                    <div class="p-2 border rounded my-2">
                        <strong>${response.user}</strong>: ${response.text}
                        <small class="text-gray-500">${response.created_at}</small>

                        <!-- Reply Form -->
                        <div class="ml-4 mt-2">
                            <form class="reply-form" data-comment-id="${response.id}">
                                <input type="text" name="text" placeholder="Reply..." class="border p-1 w-3/4">
                                <button type="submit" class="bg-blue-500 text-white px-2 py-1">Reply</button>
                            </form>
                            <div id="replies-${response.id}"></div>
                        </div>
                    </div>
                `;
                $(`#comments-section-${post_id}`).append(commentHtml);
                $(`.comment-form[data-post-id="${post_id}"] input[name='text']`).val("");
            }
        });
    });

    // Function to submit a reply via AJAX
    $(document).on("submit", ".reply-form", function (e) {
        e.preventDefault();  // Prevent page reload

        let comment_id = $(this).data("comment-id");
        let text = $(this).find("input[name='text']").val();
        let csrf_token = $("input[name='csrfmiddlewaretoken']").val();

        $.ajax({
            type: "POST",
            url: `/reply/${comment_id}/`,
            data: {
                text: text,
                csrfmiddlewaretoken: csrf_token
            },
            success: function (response) {
                let replyHtml = `
                    <div class="ml-4 p-1 border rounded">
                        <strong>${response.user}</strong>: ${response.text}
                        <small class="text-gray-500">${response.created_at}</small>
                    </div>
                `;
                $(`#replies-${response.comment_id}`).append(replyHtml);
                $(`.reply-form[data-comment-id="${comment_id}"] input[name='text']`).val("");
            }
        });
    });
});
</script>
{% endblock %}
